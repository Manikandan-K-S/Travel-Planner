{% extends 'base.html' %}

{% block title %}Itinerary Builder - {{ trip.trip_name }} - Payanam{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col lg:flex-row lg:items-center justify-between mb-6 gap-4" data-aos="fade-up">
        <div>
            <div class="flex items-center gap-2 text-sm text-gray-500 mb-2">
                <a href="{{ url_for('my_trips') }}" class="hover:text-secondary">My Trips</a>
                <i class="fas fa-chevron-right text-xs"></i>
                <span class="text-secondary">{{ trip.trip_name }}</span>
            </div>
            <h1 class="text-2xl lg:text-3xl font-bold font-playfair text-accent">{{ trip.trip_name }}</h1>
            <p class="text-gray-500">{{ trip.start_date }} - {{ trip.end_date }} | <span class="capitalize">{{
                    trip.trip_category }}</span></p>
        </div>
        <div class="flex flex-wrap gap-3">
            <button onclick="saveItinerary()" class="btn-payanam inline-flex items-center gap-2">
                <i class="fas fa-save"></i>
                Save Changes
            </button>
            <a href="{{ url_for('trip_timeline', trip_id=trip.trip_id) }}"
                class="btn-payanam-outline inline-flex items-center gap-2 no-underline">
                <i class="fas fa-eye"></i>
                Preview
            </a>
            <a href="{{ url_for('trip_budget', trip_id=trip.trip_id) }}"
                class="btn-payanam-outline inline-flex items-center gap-2 no-underline">
                <i class="fas fa-rupee-sign"></i>
                Budget
            </a>
        </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-6">
        <!-- Left Panel - Add Stop -->
        <div class="lg:col-span-1">
            <div class="card-payanam p-6 sticky top-24" data-aos="fade-right">
                <h3 class="text-lg font-bold text-accent mb-4">
                    <i class="fas fa-plus-circle text-primary mr-2"></i>Add City/Stop
                </h3>

                <form id="addStopForm">
                    <!-- City Search -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">City Name *</label>
                        <div class="relative">
                            <input type="text" id="citySearch" class="input-payanam w-full"
                                placeholder="Search Indian cities..." autocomplete="off" required>
                            <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        </div>
                        <!-- City Suggestions -->
                        <div id="citySuggestions"
                            class="absolute z-50 w-full bg-white mt-1 rounded-xl shadow-xl border border-gray-100 hidden max-h-60 overflow-y-auto">
                        </div>
                    </div>

                    <!-- Stop Categories -->
                    <div class="mb-4">
                        <label class="block text-gray-700 font-medium mb-2">Categories</label>
                        <div class="flex flex-wrap gap-2">
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="heritage" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üè∞
                                    Heritage</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="spiritual" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üõï
                                    Spiritual</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="nature" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üåø
                                    Nature</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="beach" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üèñÔ∏è
                                    Beach</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="adventure" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üèîÔ∏è
                                    Adventure</span>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="stop_category" value="family" class="hidden peer">
                                <span
                                    class="px-3 py-1 rounded-full text-sm border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">üë®‚Äçüë©‚Äçüëß
                                    Family</span>
                            </label>
                        </div>
                    </div>

                    <!-- Dates -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Arrival *</label>
                            <input type="date" id="arrivalDate" class="input-payanam w-full" required
                                min="{{ trip.start_date }}" max="{{ trip.end_date }}">
                        </div>
                        <div>
                            <label class="block text-gray-700 font-medium mb-2">Departure *</label>
                            <input type="date" id="departureDate" class="input-payanam w-full" required
                                min="{{ trip.start_date }}" max="{{ trip.end_date }}">
                        </div>
                    </div>

                    <button type="submit" class="btn-payanam w-full">
                        <i class="fas fa-plus mr-2"></i>Add Stop
                    </button>
                </form>

                <!-- Quick Add Popular Cities -->
                <div class="mt-6 pt-6 border-t">
                    <h4 class="font-medium text-gray-700 mb-3">Quick Add Popular Cities</h4>
                    <div class="flex flex-wrap gap-2" id="quickAddCities">
                        <button onclick="quickAddCity('Jaipur')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Jaipur</button>
                        <button onclick="quickAddCity('Udaipur')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Udaipur</button>
                        <button onclick="quickAddCity('Coimbatore')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Coimbatore</button>
                        <button onclick="quickAddCity('Chennai')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Chennai</button>
                        <button onclick="quickAddCity('Madurai')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Madurai</button>
                        <button onclick="quickAddCity('Goa')"
                            class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">Goa</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel - Itinerary -->
        <div class="lg:col-span-2">
            <!-- Budget Summary Bar -->
            <div class="card-payanam p-4 mb-6 gradient-cream" data-aos="fade-up">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 gradient-primary rounded-full flex items-center justify-center">
                            <i class="fas fa-rupee-sign text-white"></i>
                        </div>
                        <div>
                            <div class="text-sm text-gray-500">Total Budget</div>
                            <div class="text-xl font-bold text-accent" id="totalBudgetDisplay">‚Çπ0</div>
                        </div>
                    </div>
                    <div class="flex items-center gap-6">
                        <div class="text-center">
                            <div class="text-2xl font-bold text-secondary" id="stopsCount">0</div>
                            <div class="text-xs text-gray-500">Stops</div>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-secondary" id="activitiesCount">0</div>
                            <div class="text-xs text-gray-500">Activities</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stops List -->
            <div id="stopsContainer">
                <div class="text-center py-12 card-payanam" id="emptyState" data-aos="fade-up">
                    <div class="w-20 h-20 gradient-cream rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-map-marked-alt text-primary text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-accent mb-2">Start Building Your Itinerary</h3>
                    <p class="text-gray-500 mb-4">Add your first city to begin planning your adventure!</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Activity Modal -->
<div class="modal fade modal-payanam" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold text-accent">
                    <i class="fas fa-plus-circle text-primary mr-2"></i>Add Activity
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="activityStopIndex">
                <input type="hidden" id="activityDayIndex">

                <!-- Activity Search -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Activity Name *</label>
                    <div class="relative">
                        <input type="text" id="activityName" class="input-payanam w-full"
                            placeholder="Search activities..." autocomplete="off" required>
                        <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                    <div id="activitySuggestions"
                        class="bg-white mt-1 rounded-xl shadow-xl border border-gray-100 hidden max-h-48 overflow-y-auto">
                    </div>
                </div>

                <!-- Activity Category -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Category *</label>
                    <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="sightseeing" class="hidden peer"
                                checked>
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üì∏ Sightseeing
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="food" class="hidden peer">
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üçΩÔ∏è Food
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="shopping" class="hidden peer">
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üõçÔ∏è Shopping
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="adventure" class="hidden peer">
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üèÑ Adventure
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="relaxation" class="hidden peer">
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üíÜ Relaxation
                            </span>
                        </label>
                        <label class="cursor-pointer">
                            <input type="radio" name="activity_category" value="travel" class="hidden peer">
                            <span
                                class="block px-3 py-2 rounded-xl text-sm text-center border-2 border-gray-200 peer-checked:border-primary peer-checked:bg-primary/10 transition">
                                üöó Travel
                            </span>
                        </label>
                    </div>
                </div>

                <!-- Time & Cost -->
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Time (Optional)</label>
                        <input type="time" id="activityTime" class="input-payanam w-full">
                    </div>
                    <div>
                        <label class="block text-gray-700 font-medium mb-2">Estimated Cost (‚Çπ) *</label>
                        <input type="number" id="activityCost" class="input-payanam w-full" placeholder="0" min="0"
                            required>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label class="block text-gray-700 font-medium mb-2">Notes (Optional)</label>
                    <textarea id="activityNotes" class="input-payanam w-full h-20 resize-none"
                        placeholder="Any additional notes..."></textarea>
                </div>

                <!-- Suggested Activities -->
                <div id="suggestedActivitiesContainer" class="mt-6 pt-4 border-t hidden">
                    <h4 class="font-medium text-gray-700 mb-3">
                        <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>Suggested Activities for <span
                            id="currentCityName"></span>
                    </h4>
                    <div id="suggestedActivities" class="flex flex-wrap gap-2">
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn-payanam-outline" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn-payanam" onclick="addActivity()">
                    <i class="fas fa-plus mr-2"></i>Add Activity
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    // Indian Cities Database - Comprehensive data for Rajasthan, Tamil Nadu, Kerala and more
    const indianCities = {
        // ==================== RAJASTHAN (15 Cities) ====================
        'Jaipur': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1477587458883-47145ed94245?w=400', activities: ['Amber Fort', 'Hawa Mahal', 'City Palace Jaipur', 'Nahargarh Fort', 'Jantar Mantar', 'Jal Mahal', 'Birla Mandir Jaipur', 'Albert Hall Museum', 'Johari Bazaar Shopping', 'Chokhi Dhani Village'] },
        'Udaipur': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1568495248636-6432b97bd949?w=400', activities: ['City Palace Udaipur', 'Lake Pichola Boat Ride', 'Jag Mandir Island', 'Sajjangarh Monsoon Palace', 'Fateh Sagar Lake', 'Bagore Ki Haveli', 'Vintage Car Museum', 'Jagdish Temple', 'Saheliyon Ki Bari', 'Shilpgram Craft Village'] },
        'Jaisalmer': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1587135941948-670b381f08ce?w=400', activities: ['Jaisalmer Fort', 'Sam Sand Dunes', 'Desert Camel Safari', 'Patwon Ki Haveli', 'Desert Camping Night', 'Gadisar Lake', 'Kuldhara Ghost Village', 'Bada Bagh Cenotaphs', 'Desert Cultural Show', 'Tanot Mata Temple'] },
        'Jodhpur': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1578662996442-48f60103fc96?w=400', activities: ['Mehrangarh Fort', 'Umaid Bhawan Palace', 'Jaswant Thada', 'Mandore Gardens', 'Clock Tower Market', 'Blue City Walking Tour', 'Rao Jodha Desert Park', 'Toorji Ka Jhalra Stepwell', 'Masuria Hills Garden', 'Flying Fox Zipline'] },
        'Pushkar': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?w=400', activities: ['Brahma Temple', 'Pushkar Lake Ghats', 'Savitri Temple Trek', 'Pushkar Camel Fair', 'Rose Garden Visit', 'Old Rangji Temple', 'Varaha Temple', 'Pushkar Bazaar Shopping', 'Sunset Point Hills', 'Cooking Class Experience'] },
        'Bikaner': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1624461850043-dde2eafdb482?w=400', activities: ['Junagarh Fort', 'Karni Mata Temple', 'Lalgarh Palace', 'Camel Research Centre', 'Bikaner Camel Safari', 'Rampuria Haveli', 'Gajner Palace', 'Bhujia Snack Tasting', 'Devi Kund Sagar', 'Ganga Golden Jubilee Museum'] },
        'Mount Abu': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400', activities: ['Dilwara Jain Temples', 'Nakki Lake Boating', 'Sunset Point', 'Guru Shikhar Peak', 'Achalgarh Fort', 'Wildlife Sanctuary Safari', 'Peace Park', 'Honeymoon Point', 'Toad Rock Viewpoint', 'Trevor Tank Lake'] },
        'Ajmer': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1590766740554-f14a61e8b0a4?w=400', activities: ['Ajmer Sharif Dargah', 'Ana Sagar Lake', 'Adhai Din Ka Jhonpra', 'Taragarh Fort', 'Akbari Mosque', 'Nareli Jain Temple', 'Foy Sagar Lake', 'Soniji Ki Nasiyan', 'Magazine Museum', 'Prithviraj Smarak'] },
        'Bundi': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1599661046827-dacff0c0f09a?w=400', activities: ['Taragarh Fort Bundi', 'Bundi Palace', 'Raniji Ki Baori', 'Nawal Sagar Lake', 'Chitrashala Paintings', 'Sukh Mahal', '84 Pillared Cenotaph', 'Dabhai Kund Stepwell', 'Jait Sagar Lake', 'Phool Sagar Palace'] },
        'Chittorgarh': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1623682242968-73e5e3eca697?w=400', activities: ['Chittorgarh Fort', 'Vijay Stambha Tower', 'Kirti Stambha', 'Rana Kumbha Palace', 'Padmini Palace', 'Meera Temple', 'Gaumukh Reservoir', 'Kalika Mata Temple', 'Fateh Prakash Palace', 'Light and Sound Show'] },
        'Ranthambore': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1549366021-9f761d450615?w=400', activities: ['Tiger Safari Morning', 'Tiger Safari Evening', 'Ranthambore Fort', 'Padam Talao Lake', 'Jogi Mahal', 'Ganesh Temple', 'Surwal Lake Birds', 'Kachida Valley', 'Rajbagh Ruins', 'Wildlife Photography Tour'] },
        'Alwar': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1600100397608-e4fbcbff3e5a?w=400', activities: ['Bala Quila Fort', 'Sariska Tiger Reserve', 'Siliserh Lake Palace', 'Alwar City Palace', 'Moosi Maharani Chhatri', 'Government Museum', 'Bhangarh Fort', 'Neemrana Fort Palace', 'Vijay Mandir Palace', 'Pandupol Hanuman Temple'] },
        'Bharatpur': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Keoladeo Bird Sanctuary', 'Lohagarh Fort', 'Bharatpur Palace', 'Government Museum', 'Ganga Mandir', 'Laxman Temple', 'Deeg Palace Day Trip', 'Bird Photography Tour', 'Cycle Safari', 'Boat Ride in Sanctuary'] },
        'Mandawa': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1590766940554-f14a61e8b0a4?w=400', activities: ['Mandawa Fort', 'Haveli Heritage Walk', 'Murmuria Haveli', 'Hanuman Prasad Goenka Haveli', 'Gulab Rai Ladia Haveli', 'Jhunjhunwala Haveli', 'Open Air Art Gallery', 'Shekhawati Painting Tour', 'Camel Cart Ride', 'Village Cultural Tour'] },
        'Sawai Madhopur': { state: 'Rajasthan', image: 'https://images.unsplash.com/photo-1574068468668-a05a11f871da?w=400', activities: ['Ranthambore National Park', 'Trinetra Ganesh Temple', 'Ranthambore Fort', 'Khandar Fort', 'Chambal Safari', 'Malik Talao', 'Bakula', 'Lakarda and Anantpura', 'Raj Bagh Talao', 'Canter Safari Experience'] },

        // ==================== TAMIL NADU (15 Cities) ====================
        'Chennai': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=400', activities: ['Marina Beach Walk', 'Kapaleeshwarar Temple', 'Fort St. George', 'San Thome Cathedral', 'Government Museum', 'Valluvar Kottam', 'T Nagar Shopping', 'DakshinaChitra Heritage', 'Elliot Beach', 'Birla Planetarium'] },
        'Madurai': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1590766940554-634931ab6293?w=400', activities: ['Meenakshi Amman Temple', 'Thirumalai Nayakkar Palace', 'Gandhi Memorial Museum', 'Banana Market Visit', 'Jigarthanda Tasting', 'Alagar Kovil', 'Thirupparankundram Temple', 'Vandiyur Mariamman Teppakulam', 'Koodal Azhagar Temple', 'Pudhu Mandapam'] },
        'Coimbatore': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1593181629936-11c609b8db9b?w=400', activities: ['Isha Yoga Center', 'Dhyanalinga Meditation', 'Marudamalai Temple', 'VOC Park', 'Siruvani Waterfalls', 'Vellingiri Hills Trek', 'Perur Pateeswarar Temple', 'Gass Forest Museum', 'Brookefields Mall', 'Annapoorna Restaurant Experience'] },
        'Ooty': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Botanical Gardens', 'Ooty Lake Boating', 'Nilgiri Mountain Railway', 'Doddabetta Peak', 'Tea Factory Visit', 'Rose Garden', 'Pykara Falls', 'Avalanche Lake', 'Emerald Lake', 'Tribal Toda Village'] },
        'Kodaikanal': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1589308078059-be1415eab4c3?w=400', activities: ['Kodaikanal Lake Boating', 'Coakers Walk', 'Pillar Rocks', 'Bryant Park', 'Silver Cascade Falls', 'Pine Forest Walk', 'Green Valley View', 'Dolphins Nose Viewpoint', 'Guna Cave', 'Berijam Lake Safari'] },
        'Thanjavur': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1621427639016-5e98ea93ca2f?w=400', activities: ['Brihadeeswarar Temple', 'Thanjavur Maratha Palace', 'Saraswathi Mahal Library', 'Royal Museum', 'Schwartz Church', 'Sangeetha Mahal', 'Art Gallery Visit', 'Tanjore Painting Workshop', 'Sivaganga Park', 'Alangudi Guru Temple'] },
        'Rameswaram': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1621427639016-5e98ea93ca2f?w=400', activities: ['Ramanathaswamy Temple', 'Pamban Bridge Views', 'Dhanushkodi Ghost Town', 'Agni Theertham', 'Five-faced Hanuman Temple', 'APJ Abdul Kalam Memorial', 'Gandhamadhana Parvatham', 'Ariyaman Beach', 'Villoondi Theertham', 'Lakshmana Theertham'] },
        'Kanyakumari': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1590766940554-f14a61e8b0a4?w=400', activities: ['Vivekananda Rock Memorial', 'Thiruvalluvar Statue', 'Sunrise and Sunset Point', 'Padmanabhapuram Palace', 'Suchindram Temple', 'Kanyakumari Beach', 'Gandhi Memorial Mandapam', 'Wax Museum', 'Bhagavathy Amman Temple', 'Thirparappu Falls'] },
        'Tiruchirappalli': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=400', activities: ['Rock Fort Temple', 'Sri Ranganathaswamy Temple', 'Jambukeswarar Temple', 'St. Josephs Church', 'Kallanai Dam', 'Government Museum', 'Mukkombu Picnic', 'Amma Mandapam', 'Ucchi Pillayar Temple', 'Lourdes Church'] },
        'Mahabalipuram': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1582510003544-4d00b7f74220?w=400', activities: ['Shore Temple', 'Pancha Rathas', 'Arjunas Penance', 'Krishna Butter Ball', 'Mahabalipuram Beach', 'Tiger Cave', 'Crocodile Bank', 'Sculpture Workshop', 'Light and Sound Show', 'Mahishasuramardini Cave'] },
        'Pondicherry': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1580292923498-e3c52ada76a4?w=400', activities: ['Promenade Beach Walk', 'Auroville Matrimandir', 'French Colony Heritage Walk', 'Sri Aurobindo Ashram', 'Paradise Beach', 'Serenity Beach', 'Basilica of Sacred Heart', 'Pondicherry Museum', 'Botanical Garden', 'Arikamedu Archaeological Site'] },
        'Tirunelveli': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1590766940554-634931ab6293?w=400', activities: ['Nellaiappar Temple', 'Krishnapuram Palace', 'Courtallam Falls', 'Manimuthar Dam', 'Papanasam Falls', 'Agasthiyar Falls', 'Tiruchendur Temple', 'Kalakkad Tiger Reserve', 'Banana Chips Shopping', 'Halwa Tasting'] },
        'Salem': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=400', activities: ['Yercaud Hill Station', 'Kottai Mariamman Temple', 'Sugavaneswarar Temple', 'Salem Steel Plant Tour', 'Kiliyur Falls', 'Ladies Seat Viewpoint', 'Anna Park', 'Pagoda Point', 'Mettur Dam', 'Shevaroy Temple'] },
        'Vellore': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1600100397608-e4fbcbff3e5a?w=400', activities: ['Vellore Fort', 'Golden Temple Sripuram', 'Jalakandeswarar Temple', 'Government Museum', 'Amirthi Zoological Park', 'Science Park', 'Yelagiri Hills Day Trip', 'CMC Hospital Heritage', 'VIT Campus Visit', 'Ratnagiri Murugan Temple'] },
        'Kanchipuram': { state: 'Tamil Nadu', image: 'https://images.unsplash.com/photo-1590766940554-634931ab6293?w=400', activities: ['Kailasanathar Temple', 'Ekambareswarar Temple', 'Kamakshi Amman Temple', 'Varadharaja Perumal Temple', 'Silk Saree Shopping', 'Kanchi Kudil Heritage', 'Vaikunta Perumal Temple', 'Kailasanathar Sculptures', 'Vedanthangal Bird Sanctuary', 'Silk Weaving Demonstration'] },

        // ==================== KERALA (15 Cities) ====================
        'Kochi': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Fort Kochi Heritage Walk', 'Chinese Fishing Nets', 'Mattancherry Palace', 'Jewish Synagogue', 'Kerala Kathakali Show', 'Marine Drive Promenade', 'Lulu Mall Shopping', 'St. Francis Church', 'Jew Town Antique Shopping', 'Kerala Cooking Class'] },
        'Alleppey': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?w=400', activities: ['Houseboat Overnight Stay', 'Backwater Cruise', 'Alleppey Beach', 'Ambalapuzha Temple', 'Coir Village Visit', 'Kayaking Backwaters', 'Pathiramanal Island', 'Marari Beach', 'Krishnapuram Palace', 'Nehru Trophy Snake Boat'] },
        'Munnar': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1549880338-65ddcdfd017b?w=400', activities: ['Tea Gardens Walk', 'Eravikulam National Park', 'Mattupetty Dam', 'Echo Point', 'Tea Museum Visit', 'Top Station Viewpoint', 'Anamudi Peak View', 'Attukal Waterfalls', 'Kundala Lake', 'Rose Garden Munnar'] },
        'Thekkady': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Periyar Wildlife Sanctuary', 'Periyar Lake Boat Safari', 'Spice Plantation Tour', 'Elephant Junction', 'Bamboo Rafting', 'Jungle Night Patrol', 'Tribal Heritage Museum', 'Kadathanadan Kalari Center', 'Mangala Devi Temple', 'Chellarkovil Viewpoint'] },
        'Wayanad': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Edakkal Caves', 'Banasura Sagar Dam', 'Chembra Peak Trek', 'Soochipara Waterfalls', 'Thirunelli Temple', 'Wayanad Wildlife Sanctuary', 'Pookode Lake', 'Kuruva Island', 'Neelimala Viewpoint', 'Coffee Plantation Tour'] },
        'Thiruvananthapuram': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Padmanabhaswamy Temple', 'Kovalam Beach', 'Napier Museum', 'Veli Tourist Village', 'Poovar Island', 'Kuthiramalika Palace', 'Science and Technology Museum', 'Priyadarshini Planetarium', 'Neyyar Dam', 'Agasthyakoodam Trek'] },
        'Kovalam': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Lighthouse Beach', 'Hawa Beach', 'Samudra Beach', 'Ayurvedic Massage Spa', 'Vizhinjam Rock Cut Cave', 'Vizhinjam Fishing Village', 'Surfing Lessons', 'Yoga Retreat', 'Parasailing Adventure', 'Lighthouse Climb'] },
        'Kumarakom': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1602216056096-3b40cc0c9944?w=400', activities: ['Kumarakom Bird Sanctuary', 'Vembanad Lake Cruise', 'Houseboat Stay', 'Ayurvedic Resort', 'Bay Island Driftwood Museum', 'Aruvikkuzhi Waterfall', 'Kumarakom Beach', 'Thazhathangadi Mosque', 'Fishing Experience', 'Sunset Village Walk'] },
        'Varkala': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Varkala Beach Cliff Walk', 'Papanasam Beach', 'Janardhanaswamy Temple', 'Sivagiri Mutt', 'Kappil Beach', 'Edava Beach', 'Varkala Tunnel', 'Ayurveda Treatment', 'Cliff Top Cafes', 'Yoga on the Beach'] },
        'Thrissur': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Vadakkunnathan Temple', 'Thrissur Pooram Festival', 'Athirappilly Falls', 'Vazhachal Falls', 'Shakthan Thampuran Palace', 'Kerala Kalamandalam', 'Peechi Dam', 'Kerala Folklore Museum', 'Guruvayur Temple', 'Chettuva Backwaters'] },
        'Kozhikode': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Kozhikode Beach', 'Mananchira Square', 'Thusharagiri Waterfalls', 'Kappad Beach', 'SM Street Shopping', 'Mishkals Mosque', 'Pazhassi Raja Museum', 'Sweet Meat Street', 'Beypore Beach', 'Kadalundi Bird Sanctuary'] },
        'Kannur': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['St Angelos Fort', 'Payyambalam Beach', 'Muzhappilangad Drive-in Beach', 'Theyyam Ritual Performance', 'Kannur Lighthouse', 'Arakkal Museum', 'Dharmadam Island', 'Parassinikadavu Snake Park', 'Handloom Weaving Centre', 'Meenkunnu Beach'] },
        'Palakkad': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Palakkad Fort', 'Silent Valley National Park', 'Malampuzha Dam', 'Fantasy Park', 'Rock Garden', 'Parambikulam Tiger Reserve', 'Nelliyampathy Hills', 'Dhoni Waterfalls', 'Kalpathy Heritage Village', 'Jain Temple Jainimedu'] },
        'Athirappilly': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Athirappilly Waterfalls', 'Vazhachal Waterfalls', 'Charpa Falls', 'Sholayar Dam', 'Anakkayam Forest', 'Thumboormuzhi Dam', 'Peringalkuthu Dam', 'Rainforest Trek', 'Bamboo Rafting', 'Bird Watching Tour'] },
        'Bekal': { state: 'Kerala', image: 'https://images.unsplash.com/photo-1590050751537-eb45b8c0c9f4?w=400', activities: ['Bekal Fort', 'Bekal Beach', 'Kappil Beach', 'Nityanandashram Cave', 'Chandragiri Fort', 'Ananthapura Lake Temple', 'Bekal Hole Aqua Park', 'Backwater Cruise', 'Valiyaparamba Backwaters', 'Malik Dinar Mosque'] },

        // ==================== OTHER STATES ====================
        // Goa
        'Goa': { state: 'Goa', image: 'https://images.unsplash.com/photo-1512343879784-a960bf40e7f2?w=400', activities: ['Baga Beach', 'Calangute Beach', 'Aguada Fort', 'Basilica of Bom Jesus', 'Dudhsagar Falls', 'Saturday Night Market', 'Casino Night', 'Water Sports', 'Old Goa Churches', 'Spice Plantation Tour'] },
        'Panaji': { state: 'Goa', image: 'https://images.unsplash.com/photo-1512343879784-a960bf40e7f2?w=400', activities: ['Fontainhas Latin Quarter', 'Church of Our Lady', 'Miramar Beach', 'Casino Cruise', 'Dona Paula', 'Goa State Museum', 'Reis Magos Fort', 'Mandovi River Cruise', 'Chapel of St Sebastian', 'Municipal Garden'] },

        // Karnataka
        'Bangalore': { state: 'Karnataka', image: 'https://images.unsplash.com/photo-1596176530529-78163a4f7af2?w=400', activities: ['Lalbagh Botanical Garden', 'Cubbon Park', 'Bangalore Palace', 'UB City Mall', 'Nandi Hills Day Trip', 'Brigade Road Shopping', 'Tipu Sultans Palace', 'ISKCON Temple', 'Innovative Film City', 'Bannerghatta Safari'] },
        'Mysore': { state: 'Karnataka', image: 'https://images.unsplash.com/photo-1600100397608-e4fbcbff3e5a?w=400', activities: ['Mysore Palace', 'Chamundi Hills', 'Brindavan Gardens', 'St. Philomenas Church', 'Mysore Zoo', 'Devaraja Market', 'Jaganmohan Palace', 'Karanji Lake', 'GRS Fantasy Park', 'Silk Factory Tour'] },
        'Hampi': { state: 'Karnataka', image: 'https://images.unsplash.com/photo-1600100397608-e4fbcbff3e5a?w=400', activities: ['Virupaksha Temple', 'Vittala Temple', 'Elephant Stables', 'Hampi Bazaar', 'Coracle Ride', 'Matanga Hill Sunrise', 'Lotus Mahal', 'Queens Bath', 'Hemakuta Hill', 'Underground Shiva Temple'] },

        // Maharashtra
        'Mumbai': { state: 'Maharashtra', image: 'https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=400', activities: ['Gateway of India', 'Marine Drive', 'Elephanta Caves', 'Colaba Causeway', 'Siddhivinayak Temple', 'Juhu Beach', 'Film City Tour', 'Crawford Market', 'Haji Ali Dargah', 'Dharavi Tour'] },
        'Pune': { state: 'Maharashtra', image: 'https://images.unsplash.com/photo-1570168007204-dfb528c6958f?w=400', activities: ['Shaniwar Wada', 'Aga Khan Palace', 'Sinhagad Fort', 'Osho Ashram', 'Dagdusheth Halwai Ganpati', 'Raja Dinkar Kelkar Museum', 'Pataleshwar Cave Temple', 'Lavasa City', 'Lonavala Day Trip', 'Mahabaleshwar Trip'] },

        // Others
        'Agra': { state: 'Uttar Pradesh', image: 'https://images.unsplash.com/photo-1564507592333-c60657eea523?w=400', activities: ['Taj Mahal', 'Agra Fort', 'Fatehpur Sikri', 'Mehtab Bagh', 'Itimad-ud-Daulah', 'Kinari Bazaar', 'Akbars Tomb', 'Jama Masjid Agra', 'Taj Museum', 'Marble Handicraft'] },
        'Varanasi': { state: 'Uttar Pradesh', image: 'https://images.unsplash.com/photo-1561361513-2d000a50f0dc?w=400', activities: ['Ganga Aarti', 'Boat Ride on Ganges', 'Kashi Vishwanath Temple', 'Sarnath', 'Dashashwamedh Ghat', 'Assi Ghat', 'Manikarnika Ghat', 'BHU Campus', 'Ramnagar Fort', 'Silk Weaving Tour'] },
        'Delhi': { state: 'Delhi', image: 'https://images.unsplash.com/photo-1587474260584-136574528ed5?w=400', activities: ['Red Fort', 'Qutub Minar', 'India Gate', 'Lotus Temple', 'Humayuns Tomb', 'Chandni Chowk', 'Akshardham Temple', 'Jama Masjid', 'Gurudwara Bangla Sahib', 'Hauz Khas Village'] },
        'Shimla': { state: 'Himachal Pradesh', image: 'https://images.unsplash.com/photo-1597074866923-dc0589150358?w=400', activities: ['Mall Road', 'Ridge', 'Jakhoo Temple', 'Christ Church', 'Toy Train Ride', 'Kufri', 'Green Valley', 'Viceregal Lodge', 'Annandale', 'Chadwick Falls'] },
        'Manali': { state: 'Himachal Pradesh', image: 'https://images.unsplash.com/photo-1593181629936-11c609b8db9b?w=400', activities: ['Rohtang Pass', 'Solang Valley', 'Hadimba Temple', 'Mall Road Manali', 'River Rafting Beas', 'Old Manali Cafes', 'Vashisht Hot Springs', 'Jogini Waterfall', 'Manu Temple', 'Tibetan Monastery'] },
        'Rishikesh': { state: 'Uttarakhand', image: 'https://images.unsplash.com/photo-1586439738618-1142c0cec81f?w=400', activities: ['Laxman Jhula', 'River Rafting', 'Ganga Aarti at Parmarth', 'Beatles Ashram', 'Bungee Jumping', 'Yoga Session', 'Ram Jhula', 'Neer Garh Waterfall', 'Triveni Ghat', 'Camping Riverside'] },
        'Darjeeling': { state: 'West Bengal', image: 'https://images.unsplash.com/photo-1544735716-392fe2489ffa?w=400', activities: ['Tiger Hill Sunrise', 'Toy Train Ride', 'Tea Garden Visit', 'Peace Pagoda', 'Batasia Loop', 'Happy Valley Tea Estate', 'Himalayan Mountaineering Institute', 'Padmaja Naidu Zoo', 'Rock Garden', 'Ghoom Monastery'] }
    };

    // Current itinerary data
    let itinerary = {{ trip.itinerary_json| safe }};
    if (!itinerary.stops) itinerary.stops = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', async function () {
        // Try to fetch cities from API, fall back to hardcoded data
        await loadCitiesFromAPI();
        renderItinerary();
        setupCitySearch();
        setupActivitySearch();
    });

    // Load cities from API
    async function loadCitiesFromAPI() {
        try {
            const response = await fetch('/api/cities/frontend-format');
            if (response.ok) {
                const apiCities = await response.json();
                // If API has data, merge with existing (API takes priority)
                if (Object.keys(apiCities).length > 0) {
                    Object.assign(indianCities, apiCities);
                    console.log('Cities loaded from API:', Object.keys(apiCities).length);
                }
            }
        } catch (error) {
            console.log('Using hardcoded city data (API unavailable):', error);
        }
    }

    // City Search Setup
    function setupCitySearch() {
        const input = document.getElementById('citySearch');
        const suggestions = document.getElementById('citySuggestions');

        input.addEventListener('input', function () {
            const query = this.value.toLowerCase();
            if (query.length < 2) {
                suggestions.classList.add('hidden');
                return;
            }

            const matches = Object.entries(indianCities)
                .filter(([city, data]) =>
                    city.toLowerCase().includes(query) ||
                    data.state.toLowerCase().includes(query)
                )
                .slice(0, 8);

            if (matches.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }

            suggestions.innerHTML = matches.map(([city, data]) => `
            <div class="p-3 hover:bg-cream cursor-pointer flex items-center gap-3 border-b border-gray-50" onclick="selectCity('${city}')">
                <div class="w-10 h-10 rounded-lg overflow-hidden bg-gray-100">
                    ${data.image ? `<img src="${data.image}" class="w-full h-full object-cover">` : '<i class="fas fa-city text-gray-400 flex items-center justify-center h-full"></i>'}
                </div>
                <div>
                    <div class="font-medium text-accent">${city}</div>
                    <div class="text-xs text-gray-500">${data.state}</div>
                </div>
            </div>
        `).join('');

            suggestions.classList.remove('hidden');
        });

        // Hide suggestions on click outside
        document.addEventListener('click', function (e) {
            if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                suggestions.classList.add('hidden');
            }
        });
    }

    function selectCity(city) {
        document.getElementById('citySearch').value = city;
        document.getElementById('citySuggestions').classList.add('hidden');
    }

    function quickAddCity(city) {
        document.getElementById('citySearch').value = city;
        document.getElementById('arrivalDate').focus();
    }

    // Add Stop Form Handler
    document.getElementById('addStopForm').addEventListener('submit', function (e) {
        e.preventDefault();

        const cityName = document.getElementById('citySearch').value.trim();
        const arrivalDate = document.getElementById('arrivalDate').value;
        const departureDate = document.getElementById('departureDate').value;

        if (!cityName || !arrivalDate || !departureDate) {
            showToast('Please fill all required fields', 'error');
            return;
        }

        if (new Date(departureDate) < new Date(arrivalDate)) {
            showToast('Departure date must be after arrival date', 'error');
            return;
        }

        const categories = Array.from(document.querySelectorAll('input[name="stop_category"]:checked'))
            .map(cb => cb.value);

        // Generate days
        const days = [];
        const start = new Date(arrivalDate);
        const end = new Date(departureDate);
        let dayNum = 1;

        for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
            days.push({
                day_number: dayNum++,
                date: d.toISOString().split('T')[0],
                activities: []
            });
        }

        const stop = {
            city_name: cityName,
            state: indianCities[cityName]?.state || 'India',
            stop_category: categories,
            arrival_date: arrivalDate,
            departure_date: departureDate,
            days: days
        };

        itinerary.stops.push(stop);
        renderItinerary();
        autoSaveItinerary();
        this.reset();
        showToast(`${cityName} added to your itinerary!`, 'success');
    });

    // Render Itinerary
    function renderItinerary() {
        const container = document.getElementById('stopsContainer');

        if (itinerary.stops.length === 0) {
            container.innerHTML = `
                <div class="text-center py-12 card-payanam" id="emptyState" data-aos="fade-up">
                    <div class="w-20 h-20 gradient-cream rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-map-marked-alt text-primary text-3xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-accent mb-2">Start Building Your Itinerary</h3>
                    <p class="text-gray-500 mb-4">Add your first city to begin planning your adventure!</p>
                </div>
            `;
            updateStats();
            return;
        }

        container.innerHTML = itinerary.stops.map((stop, stopIndex) => `
        <div class="card-payanam mb-6 overflow-hidden" data-aos="fade-up">
            <!-- Stop Header -->
            <div class="gradient-primary p-4 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 bg-white/20 rounded-full flex items-center justify-center text-xl font-bold">
                            ${stopIndex + 1}
                        </div>
                        <div>
                            <h3 class="text-xl font-bold">${stop.city_name}</h3>
                            <div class="text-sm opacity-90">
                                ${stop.state || 'India'} ‚Ä¢ ${stop.arrival_date} to ${stop.departure_date}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="moveStop(${stopIndex}, -1)" class="w-8 h-8 bg-white/20 rounded-full hover:bg-white/30 transition ${stopIndex === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${stopIndex === 0 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button onclick="moveStop(${stopIndex}, 1)" class="w-8 h-8 bg-white/20 rounded-full hover:bg-white/30 transition ${stopIndex === itinerary.stops.length - 1 ? 'opacity-50 cursor-not-allowed' : ''}" ${stopIndex === itinerary.stops.length - 1 ? 'disabled' : ''}>
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button onclick="removeStop(${stopIndex})" class="w-8 h-8 bg-red-500/80 rounded-full hover:bg-red-600 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                ${stop.stop_category && stop.stop_category.length > 0 ? `
                    <div class="flex gap-2 mt-3">
                        ${stop.stop_category.map(cat => `<span class="px-2 py-1 bg-white/20 rounded-full text-xs capitalize">${cat}</span>`).join('')}
                    </div>
                ` : ''}
            </div>
            
            <!-- Days -->
            <div class="p-4">
                ${stop.days.map((day, dayIndex) => `
                    <div class="mb-4 last:mb-0">
                        <div class="flex items-center justify-between mb-3">
                            <div class="flex items-center gap-2">
                                <div class="w-8 h-8 gradient-accent rounded-full flex items-center justify-center text-white text-sm font-bold">
                                    D${day.day_number}
                                </div>
                                <span class="font-medium text-accent">Day ${day.day_number}</span>
                                <span class="text-sm text-gray-500">${day.date}</span>
                            </div>
                            <button onclick="openActivityModal(${stopIndex}, ${dayIndex})" class="text-primary hover:text-secondary transition text-sm font-medium">
                                <i class="fas fa-plus mr-1"></i>Add Activity
                            </button>
                        </div>
                        
                        <div id="activities-${stopIndex}-${dayIndex}" class="ml-10 space-y-2">
                            ${day.activities.length === 0 ? `
                                <div class="p-4 bg-gray-50 rounded-xl text-center text-gray-400 text-sm activity-empty">
                                    No activities planned yet. Click "Add Activity" to start!
                                </div>
                            ` : day.activities.map((activity, actIndex) => `
                                <div class="activity-item p-3 bg-cream rounded-xl flex items-center justify-between group" data-index="${actIndex}">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 ${getCategoryColor(activity.category)} rounded-lg flex items-center justify-center text-white text-sm">
                                            ${getCategoryIcon(activity.category)}
                                        </div>
                                        <div>
                                            <div class="font-medium text-accent">${activity.activity_name}</div>
                                            <div class="text-xs text-gray-500">
                                                ${activity.time ? activity.time + ' ‚Ä¢ ' : ''}
                                                <span class="capitalize">${activity.category}</span>
                                                ${activity.notes ? ' ‚Ä¢ ' + activity.notes : ''}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span class="font-bold text-secondary mr-2">‚Çπ${activity.estimated_cost}</span>
                                        <div class="flex items-center gap-1">
                                            <button type="button" onclick="event.stopPropagation(); moveActivity(${stopIndex}, ${dayIndex}, ${actIndex}, -1)" class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-100 hover:bg-blue-500 hover:text-white text-blue-600 transition ${actIndex === 0 ? 'opacity-30 cursor-not-allowed' : ''}" ${actIndex === 0 ? 'disabled' : ''} title="Move up">
                                                <i class="fas fa-arrow-up"></i>
                                            </button>
                                            <button type="button" onclick="event.stopPropagation(); moveActivity(${stopIndex}, ${dayIndex}, ${actIndex}, 1)" class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-100 hover:bg-blue-500 hover:text-white text-blue-600 transition ${actIndex === day.activities.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" ${actIndex === day.activities.length - 1 ? 'disabled' : ''} title="Move down">
                                                <i class="fas fa-arrow-down"></i>
                                            </button>
                                            <button type="button" onclick="event.stopPropagation(); removeActivity(${stopIndex}, ${dayIndex}, ${actIndex})" class="w-7 h-7 flex items-center justify-center rounded-lg bg-red-100 hover:bg-red-500 hover:text-white text-red-600 transition" title="Remove">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `).join('');

        updateStats();
    }

    // Helper functions for activity display
    function getCategoryColor(category) {
        const colors = {
            sightseeing: 'bg-blue-500',
            food: 'bg-orange-500',
            shopping: 'bg-pink-500',
            adventure: 'bg-green-500',
            relaxation: 'bg-purple-500',
            travel: 'bg-gray-500'
        };
        return colors[category] || 'bg-gray-500';
    }

    function getCategoryIcon(category) {
        const icons = {
            sightseeing: '<i class="fas fa-camera"></i>',
            food: '<i class="fas fa-utensils"></i>',
            shopping: '<i class="fas fa-shopping-bag"></i>',
            adventure: '<i class="fas fa-hiking"></i>',
            relaxation: '<i class="fas fa-spa"></i>',
            travel: '<i class="fas fa-car"></i>'
        };
        return icons[category] || '<i class="fas fa-star"></i>';
    }

    // Activity Modal
    // Global modal instance
    let activityModalInstance = null;

    function openActivityModal(stopIndex, dayIndex) {
        document.getElementById('activityStopIndex').value = stopIndex;
        document.getElementById('activityDayIndex').value = dayIndex;
        document.getElementById('activityName').value = '';
        document.getElementById('activityCost').value = '';
        document.getElementById('activityTime').value = '';
        document.getElementById('activityNotes').value = '';

        // Show suggested activities
        const cityName = itinerary.stops[stopIndex].city_name;
        const cityData = indianCities[cityName];

        if (cityData && cityData.activities) {
            document.getElementById('currentCityName').textContent = cityName;
            document.getElementById('suggestedActivities').innerHTML = cityData.activities.map(act => `
            <button onclick="selectSuggestedActivity('${act}')" class="px-3 py-1 text-sm bg-cream text-accent rounded-full hover:bg-primary/20 transition">
                ${act}
            </button>
        `).join('');
            document.getElementById('suggestedActivitiesContainer').classList.remove('hidden');
        } else {
            document.getElementById('suggestedActivitiesContainer').classList.add('hidden');
        }

        const modalEl = document.getElementById('activityModal');
        if (!activityModalInstance) {
            activityModalInstance = new bootstrap.Modal(modalEl);
        }
        activityModalInstance.show();
    }

    function selectSuggestedActivity(activityName) {
        document.getElementById('activityName').value = activityName;
        document.getElementById('activityCost').focus();
    }

    // Activity Search Setup
    function setupActivitySearch() {
        const input = document.getElementById('activityName');
        const suggestions = document.getElementById('activitySuggestions');

        input.addEventListener('input', function () {
            const stopIndex = document.getElementById('activityStopIndex').value;
            const cityName = itinerary.stops[stopIndex]?.city_name;
            const cityData = indianCities[cityName];

            if (!cityData || !cityData.activities) {
                suggestions.classList.add('hidden');
                return;
            }

            const query = this.value.toLowerCase();
            if (query.length < 1) {
                suggestions.classList.add('hidden');
                return;
            }

            const matches = cityData.activities.filter(act =>
                act.toLowerCase().includes(query)
            );

            if (matches.length === 0) {
                suggestions.classList.add('hidden');
                return;
            }

            suggestions.innerHTML = matches.map(act => `
            <div class="p-3 hover:bg-cream cursor-pointer" onclick="document.getElementById('activityName').value='${act}'; document.getElementById('activitySuggestions').classList.add('hidden');">
                ${act}
            </div>
        `).join('');

            suggestions.classList.remove('hidden');
        });
    }

    function addActivity() {
        const stopIndex = parseInt(document.getElementById('activityStopIndex').value);
        const dayIndex = parseInt(document.getElementById('activityDayIndex').value);
        const activityName = document.getElementById('activityName').value.trim();
        const category = document.querySelector('input[name="activity_category"]:checked').value;
        const cost = parseFloat(document.getElementById('activityCost').value) || 0;
        const time = document.getElementById('activityTime').value;
        const notes = document.getElementById('activityNotes').value.trim();

        if (!activityName) {
            showToast('Please enter an activity name', 'error');
            return;
        }

        const activity = {
            activity_name: activityName,
            category: category,
            estimated_cost: cost,
            time: time,
            notes: notes
        };

        itinerary.stops[stopIndex].days[dayIndex].activities.push(activity);
        renderItinerary();
        autoSaveItinerary();

        if (activityModalInstance) {
            activityModalInstance.hide();
        }
        showToast('Activity added successfully!', 'success');
    }

    function removeActivity(stopIndex, dayIndex, actIndex) {
        if (confirm('Remove this activity?')) {
            // Animate removal
            const container = document.getElementById(`activities-${stopIndex}-${dayIndex}`);
            const items = container.querySelectorAll('.activity-item');
            const itemToRemove = items[actIndex];
            
            if (itemToRemove) {
                itemToRemove.style.transform = 'translateX(100%)';
                itemToRemove.style.opacity = '0';
                itemToRemove.style.transition = 'transform 0.3s ease-out, opacity 0.3s ease-out';
                
                setTimeout(() => {
                    itinerary.stops[stopIndex].days[dayIndex].activities.splice(actIndex, 1);
                    renderDayActivities(stopIndex, dayIndex);
                    autoSaveItinerary();
                    showToast('Activity removed', 'success');
                }, 300);
            } else {
                itinerary.stops[stopIndex].days[dayIndex].activities.splice(actIndex, 1);
                renderDayActivities(stopIndex, dayIndex);
                autoSaveItinerary();
                showToast('Activity removed', 'success');
            }
        }
    }

    function moveActivity(stopIndex, dayIndex, actIndex, direction) {
        const activities = itinerary.stops[stopIndex].days[dayIndex].activities;
        const newIndex = actIndex + direction;
        
        if (newIndex < 0 || newIndex >= activities.length) return;
        
        // Get the activity elements for animation
        const container = document.getElementById(`activities-${stopIndex}-${dayIndex}`);
        const items = container.querySelectorAll('.activity-item');
        const currentItem = items[actIndex];
        const targetItem = items[newIndex];
        
        if (currentItem && targetItem) {
            // Add animation classes
            currentItem.style.transform = direction === -1 ? 'translateY(-100%)' : 'translateY(100%)';
            targetItem.style.transform = direction === -1 ? 'translateY(100%)' : 'translateY(-100%)';
            currentItem.style.transition = 'transform 0.2s ease-out';
            targetItem.style.transition = 'transform 0.2s ease-out';
            
            setTimeout(() => {
                // Swap in data
                const temp = activities[actIndex];
                activities[actIndex] = activities[newIndex];
                activities[newIndex] = temp;
                
                // Re-render only this day's activities
                renderDayActivities(stopIndex, dayIndex);
                autoSaveItinerary();
            }, 200);
        } else {
            // Fallback if elements not found
            const temp = activities[actIndex];
            activities[actIndex] = activities[newIndex];
            activities[newIndex] = temp;
            renderDayActivities(stopIndex, dayIndex);
            autoSaveItinerary();
        }
    }

    // Render only a specific day's activities (for smooth updates)
    function renderDayActivities(stopIndex, dayIndex) {
        const container = document.getElementById(`activities-${stopIndex}-${dayIndex}`);
        if (!container) return;
        
        const day = itinerary.stops[stopIndex].days[dayIndex];
        
        container.innerHTML = day.activities.length === 0 ? `
            <div class="p-4 bg-gray-50 rounded-xl text-center text-gray-400 text-sm activity-empty">
                No activities planned yet. Click "Add Activity" to start!
            </div>
        ` : day.activities.map((activity, actIndex) => `
            <div class="activity-item p-3 bg-cream rounded-xl flex items-center justify-between group" data-index="${actIndex}">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 ${getCategoryColor(activity.category)} rounded-lg flex items-center justify-center text-white text-sm">
                        ${getCategoryIcon(activity.category)}
                    </div>
                    <div>
                        <div class="font-medium text-accent">${activity.activity_name}</div>
                        <div class="text-xs text-gray-500">
                            ${activity.time ? activity.time + ' ‚Ä¢ ' : ''}
                            <span class="capitalize">${activity.category}</span>
                            ${activity.notes ? ' ‚Ä¢ ' + activity.notes : ''}
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span class="font-bold text-secondary mr-2">‚Çπ${activity.estimated_cost}</span>
                    <div class="flex items-center gap-1">
                        <button type="button" onclick="event.stopPropagation(); moveActivity(${stopIndex}, ${dayIndex}, ${actIndex}, -1)" class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-100 hover:bg-blue-500 hover:text-white text-blue-600 transition ${actIndex === 0 ? 'opacity-30 cursor-not-allowed' : ''}" ${actIndex === 0 ? 'disabled' : ''} title="Move up">
                            <i class="fas fa-arrow-up"></i>
                        </button>
                        <button type="button" onclick="event.stopPropagation(); moveActivity(${stopIndex}, ${dayIndex}, ${actIndex}, 1)" class="w-7 h-7 flex items-center justify-center rounded-lg bg-blue-100 hover:bg-blue-500 hover:text-white text-blue-600 transition ${actIndex === day.activities.length - 1 ? 'opacity-30 cursor-not-allowed' : ''}" ${actIndex === day.activities.length - 1 ? 'disabled' : ''} title="Move down">
                            <i class="fas fa-arrow-down"></i>
                        </button>
                        <button type="button" onclick="event.stopPropagation(); removeActivity(${stopIndex}, ${dayIndex}, ${actIndex})" class="w-7 h-7 flex items-center justify-center rounded-lg bg-red-100 hover:bg-red-500 hover:text-white text-red-600 transition" title="Remove">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `).join('');
        
        updateStats();
    }

    function removeStop(stopIndex) {
        if (confirm('Remove this city from your itinerary?')) {
            itinerary.stops.splice(stopIndex, 1);
            renderItinerary();
            autoSaveItinerary();
            showToast('City removed from itinerary', 'success');
        }
    }

    function moveStop(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= itinerary.stops.length) return;

        const temp = itinerary.stops[index];
        itinerary.stops[index] = itinerary.stops[newIndex];
        itinerary.stops[newIndex] = temp;
        renderItinerary();
        autoSaveItinerary();
    }

    // Update Stats
    function updateStats() {
        let totalBudget = 0;
        let totalActivities = 0;

        itinerary.stops.forEach(stop => {
            stop.days.forEach(day => {
                day.activities.forEach(activity => {
                    totalBudget += parseFloat(activity.estimated_cost) || 0;
                    totalActivities++;
                });
            });
        });

        document.getElementById('totalBudgetDisplay').textContent = '‚Çπ' + totalBudget.toLocaleString('en-IN');
        document.getElementById('stopsCount').textContent = itinerary.stops.length;
        document.getElementById('activitiesCount').textContent = totalActivities;
    }

    // Auto-save Itinerary (silent save)
    function autoSaveItinerary() {
        let totalBudget = 0;
        itinerary.stops.forEach(stop => {
            stop.days.forEach(day => {
                day.activities.forEach(activity => {
                    totalBudget += parseFloat(activity.estimated_cost) || 0;
                });
            });
        });

        fetch('/api/trip/{{ trip.trip_id }}/itinerary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(itinerary)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update budget silently
                    fetch('/api/trip/{{ trip.trip_id }}/budget', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ total_budget: totalBudget })
                    });
                    // Show subtle save indicator
                    showSaveIndicator();
                }
            })
            .catch(error => {
                console.error('Auto-save failed:', error);
            });
    }

    // Show subtle save indicator
    function showSaveIndicator() {
        const indicator = document.createElement('div');
        indicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-full text-sm flex items-center gap-2 shadow-lg z-50 animate-fade-in';
        indicator.innerHTML = '<i class="fas fa-check-circle"></i> Saved';
        document.body.appendChild(indicator);
        
        setTimeout(() => {
            indicator.style.opacity = '0';
            indicator.style.transition = 'opacity 0.3s ease';
            setTimeout(() => indicator.remove(), 300);
        }, 1500);
    }

    // Manual Save Itinerary (with toast)
    function saveItinerary() {
        let totalBudget = 0;
        itinerary.stops.forEach(stop => {
            stop.days.forEach(day => {
                day.activities.forEach(activity => {
                    totalBudget += parseFloat(activity.estimated_cost) || 0;
                });
            });
        });

        fetch('/api/trip/{{ trip.trip_id }}/itinerary', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(itinerary)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update budget
                    fetch('/api/trip/{{ trip.trip_id }}/budget', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ total_budget: totalBudget })
                    });
                    showToast('Itinerary saved successfully!', 'success');
                } else {
                    showToast('Failed to save itinerary', 'error');
                }
            })
            .catch(error => {
                showToast('Failed to save itinerary', 'error');
            });
    }
</script>
{% endblock %}