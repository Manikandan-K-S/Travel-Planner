{% extends 'base.html' %}

{% block title %}My Trips - Payanam{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8" data-aos="fade-up">
        <div>
            <h1 class="text-3xl font-bold font-playfair text-accent mb-2">My Trips</h1>
            <p class="text-gray-600">Manage and view all your travel plans</p>
        </div>
        <a href="{{ url_for('create_trip') }}" class="btn-payanam inline-flex items-center gap-2 no-underline mt-4 md:mt-0">
            <i class="fas fa-plus"></i>
            Create New Trip
        </a>
    </div>
    
    <!-- Filters -->
    <div class="card-payanam p-4 mb-8" data-aos="fade-up" data-aos-delay="100">
        <div class="flex flex-wrap gap-4 items-center">
            <div class="flex items-center gap-2">
                <i class="fas fa-filter text-primary"></i>
                <span class="font-medium text-gray-700">Filter:</span>
            </div>
            <button onclick="filterTrips('all')" class="filter-btn active px-4 py-2 rounded-full text-sm font-medium transition" data-filter="all">
                All Trips
            </button>
            <button onclick="filterTrips('upcoming')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition" data-filter="upcoming">
                Upcoming
            </button>
            <button onclick="filterTrips('past')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition" data-filter="past">
                Past
            </button>
            <button onclick="filterTrips('public')" class="filter-btn px-4 py-2 rounded-full text-sm font-medium transition" data-filter="public">
                Public
            </button>
            
            <div class="ml-auto relative">
                <input type="text" id="searchTrips" placeholder="Search trips..." 
                       class="input-payanam py-2 pl-10 pr-4"
                       onkeyup="searchTrips()">
                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
            </div>
        </div>
    </div>
    
    <!-- Trips Grid -->
    {% if trips %}
    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6" id="tripsGrid">
        {% for trip in trips %}
        <div class="trip-card card-payanam overflow-hidden group" 
             data-name="{{ trip.trip_name|lower }}"
             data-start="{{ trip.start_date }}"
             data-public="{{ trip.is_public }}"
             data-aos="fade-up" 
             data-aos-delay="{{ loop.index * 50 }}">
            <div class="relative h-48 overflow-hidden bg-gradient-to-br from-primary/20 to-secondary/20">
                {% if trip.cover_image %}
                <img src="{{ trip.cover_image }}" alt="{{ trip.trip_name }}" class="w-full h-full object-cover group-hover:scale-110 transition duration-500">
                {% else %}
                <div class="w-full h-full flex items-center justify-center bg-gradient-to-br from-cream to-white">
                    <i class="fas fa-mountain text-6xl text-primary/30"></i>
                </div>
                {% endif %}
                
                <div class="absolute top-4 left-4 badge-payanam capitalize">
                    {{ trip.trip_category }}
                </div>
                
                <div class="absolute top-4 right-4 flex gap-2">
                    {% if trip.is_public %}
                    <span class="bg-green-500 text-white px-2 py-1 rounded-full text-xs">
                        <i class="fas fa-globe mr-1"></i>Public
                    </span>
                    {% endif %}
                </div>
                
                <!-- Quick Actions Overlay -->
                <div class="absolute inset-0 bg-black/50 flex items-center justify-center gap-3 opacity-0 group-hover:opacity-100 transition duration-300">
                    <a href="{{ url_for('itinerary_builder', trip_id=trip.trip_id) }}" 
                       class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-secondary hover:scale-110 transition no-underline"
                       title="Edit Itinerary">
                        <i class="fas fa-edit"></i>
                    </a>
                    <a href="{{ url_for('view_trip', trip_id=trip.trip_id) }}" 
                       class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-secondary hover:scale-110 transition no-underline"
                       title="View Trip">
                        <i class="fas fa-eye"></i>
                    </a>
                    <a href="{{ url_for('trip_timeline', trip_id=trip.trip_id) }}" 
                       class="w-10 h-10 bg-white rounded-full flex items-center justify-center text-secondary hover:scale-110 transition no-underline"
                       title="View Timeline">
                        <i class="fas fa-stream"></i>
                    </a>
                    <button onclick="deleteTrip('{{ trip.trip_id }}')" 
                            class="w-10 h-10 bg-red-500 rounded-full flex items-center justify-center text-white hover:scale-110 transition"
                            title="Delete Trip">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
            
            <div class="p-6">
                <h3 class="text-lg font-bold text-accent mb-2 truncate">{{ trip.trip_name }}</h3>
                
                {% if trip.trip_description %}
                <p class="text-gray-500 text-sm mb-3 line-clamp-2">{{ trip.trip_description }}</p>
                {% endif %}
                
                <div class="space-y-2 mb-4">
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <i class="fas fa-calendar w-4"></i>
                        <span>{{ trip.start_date }} - {{ trip.end_date }}</span>
                    </div>
                    {% if trip.total_budget > 0 %}
                    <div class="flex items-center gap-2 text-gray-500 text-sm">
                        <i class="fas fa-rupee-sign w-4"></i>
                        <span>â‚¹{{ "%.2f"|format(trip.total_budget) }}</span>
                    </div>
                    {% endif %}
                </div>
                
                <div class="flex gap-2">
                    <a href="{{ url_for('itinerary_builder', trip_id=trip.trip_id) }}" 
                       class="flex-1 btn-payanam text-center text-sm py-2 no-underline">
                        <i class="fas fa-edit mr-1"></i>Edit
                    </a>
                    <a href="{{ url_for('view_trip', trip_id=trip.trip_id) }}" 
                       class="flex-1 btn-payanam-outline text-center text-sm py-2 no-underline">
                        <i class="fas fa-eye mr-1"></i>View
                    </a>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card-payanam p-12 text-center" data-aos="fade-up">
        <div class="w-24 h-24 gradient-primary rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-suitcase-rolling text-white text-4xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-accent mb-2">No trips yet!</h3>
        <p class="text-gray-600 mb-6 max-w-md mx-auto">
            Start your Indian adventure by creating your first trip. 
            Explore Rajasthan's palaces, Tamil Nadu's temples, or Kerala's backwaters!
        </p>
        <a href="{{ url_for('create_trip') }}" class="btn-payanam inline-flex items-center gap-2 no-underline">
            <i class="fas fa-plus"></i>
            Create Your First Trip
        </a>
    </div>
    {% endif %}
    
    <!-- Empty State for Filters -->
    <div class="card-payanam p-12 text-center hidden" id="noResults" data-aos="fade-up">
        <div class="w-20 h-20 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-search text-gray-400 text-3xl"></i>
        </div>
        <h3 class="text-xl font-bold text-accent mb-2">No trips found</h3>
        <p class="text-gray-600">Try adjusting your filters or search query.</p>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade modal-payanam" id="deleteModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title font-bold text-accent">
                    <i class="fas fa-exclamation-triangle text-red-500 mr-2"></i>Delete Trip
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center py-6">
                <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-trash text-red-500 text-2xl"></i>
                </div>
                <p class="text-gray-600">Are you sure you want to delete this trip? This action cannot be undone.</p>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn-payanam-outline" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="bg-red-500 text-white px-6 py-2 rounded-full font-medium hover:bg-red-600 transition" onclick="confirmDelete()">
                    Delete Trip
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
    .filter-btn {
        background: white;
        color: #666;
        border: 2px solid transparent;
    }
    
    .filter-btn:hover {
        border-color: var(--primary);
        color: var(--secondary);
    }
    
    .filter-btn.active {
        background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        color: white;
    }
    
    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
    const today = new Date().toISOString().split('T')[0];
    let tripToDelete = null;
    
    function filterTrips(filter) {
        // Update active button
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.classList.remove('active');
            if (btn.dataset.filter === filter) {
                btn.classList.add('active');
            }
        });
        
        const trips = document.querySelectorAll('.trip-card');
        let visibleCount = 0;
        
        trips.forEach(trip => {
            const startDate = trip.dataset.start;
            const isPublic = trip.dataset.public === 'True';
            let show = true;
            
            switch(filter) {
                case 'upcoming':
                    show = startDate >= today;
                    break;
                case 'past':
                    show = startDate < today;
                    break;
                case 'public':
                    show = isPublic;
                    break;
                default:
                    show = true;
            }
            
            trip.style.display = show ? 'block' : 'none';
            if (show) visibleCount++;
        });
        
        document.getElementById('noResults').classList.toggle('hidden', visibleCount > 0);
    }
    
    function searchTrips() {
        const query = document.getElementById('searchTrips').value.toLowerCase();
        const trips = document.querySelectorAll('.trip-card');
        let visibleCount = 0;
        
        trips.forEach(trip => {
            const name = trip.dataset.name;
            const show = name.includes(query);
            trip.style.display = show ? 'block' : 'none';
            if (show) visibleCount++;
        });
        
        document.getElementById('noResults').classList.toggle('hidden', visibleCount > 0);
    }
    
    function deleteTrip(tripId) {
        tripToDelete = tripId;
        const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
        modal.show();
    }
    
    function confirmDelete() {
        if (tripToDelete) {
            fetch(`/trip/${tripToDelete}/delete`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    showToast('Failed to delete trip', 'error');
                }
            })
            .catch(error => {
                showToast('Failed to delete trip', 'error');
            });
        }
    }
</script>
{% endblock %}
