{% extends 'base.html' %}

{% block title %}Analytics - Payanam{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex flex-col md:flex-row md:items-center justify-between mb-8" data-aos="fade-up">
        <div>
            <h1 class="text-3xl font-bold font-playfair text-accent mb-2">Travel Analytics</h1>
            <p class="text-gray-500">Insights into your travel patterns and spending</p>
        </div>
        <div class="flex gap-3 mt-4 md:mt-0">
            <select id="timeRange" class="input-payanam py-2" onchange="updateAnalytics()">
                <option value="all">All Time</option>
                <option value="year">This Year</option>
                <option value="month">This Month</option>
            </select>
        </div>
    </div>
    
    <!-- Overview Stats -->
    <div class="grid md:grid-cols-4 gap-6 mb-8">
        <div class="card-payanam p-6 relative overflow-hidden" data-aos="fade-up">
            <div class="absolute top-0 right-0 w-32 h-32 gradient-primary opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 gradient-primary rounded-2xl flex items-center justify-center">
                        <i class="fas fa-plane text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-accent">{{ analytics.total_trips }}</div>
                        <div class="text-gray-500">Total Trips</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-payanam p-6 relative overflow-hidden" data-aos="fade-up" data-aos-delay="100">
            <div class="absolute top-0 right-0 w-32 h-32 bg-green-500 opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-green-500 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-map-marker-alt text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-accent">{{ analytics.city_visits|length }}</div>
                        <div class="text-gray-500">Cities Explored</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-payanam p-6 relative overflow-hidden" data-aos="fade-up" data-aos-delay="200">
            <div class="absolute top-0 right-0 w-32 h-32 bg-blue-500 opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-blue-500 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-hiking text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-accent" id="totalActivities">0</div>
                        <div class="text-gray-500">Activities</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card-payanam p-6 relative overflow-hidden" data-aos="fade-up" data-aos-delay="300">
            <div class="absolute top-0 right-0 w-32 h-32 bg-purple-500 opacity-10 rounded-full -translate-y-1/2 translate-x-1/2"></div>
            <div class="relative">
                <div class="flex items-center gap-4">
                    <div class="w-14 h-14 bg-purple-500 rounded-2xl flex items-center justify-center">
                        <i class="fas fa-rupee-sign text-white text-xl"></i>
                    </div>
                    <div>
                        <div class="text-3xl font-bold text-accent">₹{{ "%.0f"|format(analytics.total_budget) }}</div>
                        <div class="text-gray-500">Total Spent</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <!-- Cities Visited Chart -->
        <div class="card-payanam p-6" data-aos="fade-up">
            <h3 class="text-xl font-bold text-accent mb-6">
                <i class="fas fa-city text-primary mr-2"></i>Most Visited Cities
            </h3>
            <div class="relative">
                <canvas id="citiesChart" height="300"></canvas>
            </div>
        </div>
        
        <!-- Activity Types Chart -->
        <div class="card-payanam p-6" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-xl font-bold text-accent mb-6">
                <i class="fas fa-chart-pie text-primary mr-2"></i>Activity Distribution
            </h3>
            <div class="relative">
                <canvas id="activityTypesChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <div class="grid lg:grid-cols-2 gap-8 mb-8">
        <!-- Trip Categories -->
        <div class="card-payanam p-6" data-aos="fade-up">
            <h3 class="text-xl font-bold text-accent mb-6">
                <i class="fas fa-tags text-primary mr-2"></i>Trip Categories
            </h3>
            <div class="space-y-4" id="categoryBreakdown">
                {% for cat, count in analytics.category_count.items() %}
                <div class="flex items-center gap-4">
                    <div class="w-24 font-medium text-gray-600 capitalize">{{ cat }}</div>
                    <div class="flex-1 bg-gray-100 rounded-full h-4 overflow-hidden">
                        <div class="gradient-primary h-full rounded-full" style="width: {{ (count / analytics.total_trips * 100) if analytics.total_trips > 0 else 0 }}%"></div>
                    </div>
                    <div class="w-12 text-right font-bold text-secondary">{{ count }}</div>
                </div>
                {% endfor %}
            </div>
        </div>
        
        <!-- Budget by Trip -->
        <div class="card-payanam p-6" data-aos="fade-up" data-aos-delay="100">
            <h3 class="text-xl font-bold text-accent mb-6">
                <i class="fas fa-wallet text-primary mr-2"></i>Budget by Trip
            </h3>
            <div class="relative">
                <canvas id="budgetByTripChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Travel Map Visualization -->
    <div class="card-payanam p-6 mb-8" data-aos="fade-up">
        <h3 class="text-xl font-bold text-accent mb-6">
            <i class="fas fa-map text-primary mr-2"></i>Your Travel Footprint
        </h3>
        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4" id="travelFootprint">
            {% for city, count in analytics.city_visits.items() %}
            <div class="text-center p-4 bg-cream rounded-xl hover:shadow-lg transition cursor-pointer group">
                <div class="w-12 h-12 gradient-primary rounded-full flex items-center justify-center mx-auto mb-2 group-hover:scale-110 transition">
                    <span class="text-white font-bold">{{ count }}</span>
                </div>
                <div class="font-medium text-accent text-sm">{{ city }}</div>
                <div class="text-xs text-gray-500">{{ count }} visit{{ 's' if count > 1 else '' }}</div>
            </div>
            {% endfor %}
        </div>
        {% if not analytics.city_visits %}
        <div class="text-center py-8 text-gray-400">
            <i class="fas fa-map-marked-alt text-4xl mb-4"></i>
            <p>Start exploring to see your travel footprint!</p>
        </div>
        {% endif %}
    </div>
    
    <!-- Recent Trips Timeline -->
    <div class="card-payanam p-6" data-aos="fade-up">
        <h3 class="text-xl font-bold text-accent mb-6">
            <i class="fas fa-history text-primary mr-2"></i>Recent Trips
        </h3>
        {% if trips %}
        <div class="space-y-4">
            {% for trip in trips[:5] %}
            <div class="flex items-center gap-4 p-4 bg-cream rounded-xl hover:shadow-md transition">
                <div class="w-12 h-12 gradient-primary rounded-xl flex items-center justify-center text-white">
                    <i class="fas fa-suitcase"></i>
                </div>
                <div class="flex-1">
                    <div class="font-medium text-accent">{{ trip.trip_name }}</div>
                    <div class="text-sm text-gray-500">{{ trip.start_date }} - {{ trip.end_date }}</div>
                </div>
                <div class="text-right">
                    <div class="font-bold text-secondary">₹{{ "%.0f"|format(trip.total_budget) }}</div>
                    <div class="text-xs text-gray-500 capitalize">{{ trip.trip_category }}</div>
                </div>
                <a href="{{ url_for('view_trip', trip_id=trip.trip_id) }}" class="text-primary hover:text-secondary">
                    <i class="fas fa-arrow-right"></i>
                </a>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8 text-gray-400">
            <i class="fas fa-plane-departure text-4xl mb-4"></i>
            <p>No trips yet. Start planning your first adventure!</p>
            <a href="{{ url_for('create_trip') }}" class="btn-payanam inline-block mt-4 no-underline">
                Create Trip
            </a>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const analyticsData = {{ analytics|tojson|safe }};
    
    // Calculate total activities
    let totalActivities = 0;
    Object.values(analyticsData.activity_types || {}).forEach(count => {
        totalActivities += count;
    });
    document.getElementById('totalActivities').textContent = totalActivities;
    
    // Cities Chart
    const cityData = Object.entries(analyticsData.city_visits || {}).sort((a, b) => b[1] - a[1]).slice(0, 8);
    
    if (cityData.length > 0) {
        new Chart(document.getElementById('citiesChart'), {
            type: 'bar',
            data: {
                labels: cityData.map(([city]) => city),
                datasets: [{
                    label: 'Visits',
                    data: cityData.map(([_, count]) => count),
                    backgroundColor: 'rgba(234, 123, 123, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                indexAxis: 'y',
                plugins: { legend: { display: false } },
                scales: {
                    x: { beginAtZero: true }
                }
            }
        });
    }
    
    // Activity Types Doughnut Chart
    const activityData = Object.entries(analyticsData.activity_types || {}).filter(([_, v]) => v > 0);
    const activityColors = ['#EA7B7B', '#D25353', '#9E3B3B', '#FF9B9B', '#FFB4B4', '#FFC8C8'];
    
    if (activityData.length > 0) {
        new Chart(document.getElementById('activityTypesChart'), {
            type: 'doughnut',
            data: {
                labels: activityData.map(([cat]) => cat.charAt(0).toUpperCase() + cat.slice(1)),
                datasets: [{
                    data: activityData.map(([_, count]) => count),
                    backgroundColor: activityColors.slice(0, activityData.length),
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                cutout: '60%',
                plugins: {
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });
    }
    
    // Budget by Trip Chart
    const trips = {{ trips|tojson|safe if trips else '[]' }};
    const budgetData = trips.slice(0, 8).map(t => ({
        name: t.trip_name.length > 15 ? t.trip_name.substring(0, 15) + '...' : t.trip_name,
        budget: t.total_budget
    }));
    
    if (budgetData.length > 0) {
        new Chart(document.getElementById('budgetByTripChart'), {
            type: 'bar',
            data: {
                labels: budgetData.map(t => t.name),
                datasets: [{
                    label: 'Budget',
                    data: budgetData.map(t => t.budget),
                    backgroundColor: 'rgba(210, 83, 83, 0.8)',
                    borderRadius: 8
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { display: false } },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '₹' + value.toLocaleString('en-IN');
                            }
                        }
                    }
                }
            }
        });
    }
</script>
{% endblock %}
