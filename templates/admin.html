{% extends 'base.html' %}

{% block title %}Admin Panel - Payanam{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Header -->
    <div class="flex items-center justify-between mb-8" data-aos="fade-up">
        <div>
            <h1 class="text-3xl font-bold text-accent font-playfair">Admin Dashboard</h1>
            <p class="text-gray-600">Manage your Payanam platform</p>
        </div>
        <a href="{{ url_for('admin_logout') }}" class="btn-payanam-outline">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </a>
    </div>

    <!-- Analytics Section (Frontend Only) -->
    <div class="grid md:grid-cols-4 gap-6 mb-8" data-aos="fade-up">
        <div class="card-payanam p-6 text-center animate-pulse">
            <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-crown text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-accent">Most Popular City</h3>
            <p class="text-lg text-primary font-semibold">Jaipur</p>
            <p class="text-xs text-gray-500 mt-1">Based on user trips</p>
        </div>
        <div class="card-payanam p-6 text-center animate-pulse">
            <div class="w-16 h-16 gradient-accent rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-hiking text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-accent">Top Activity</h3>
            <p class="text-lg text-primary font-semibold">Amber Fort Tour</p>
            <p class="text-xs text-gray-500 mt-1">Jaipur, Rajasthan</p>
        </div>
        <div class="card-payanam p-6 text-center animate-pulse">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-user-astronaut text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-accent">Top User</h3>
            <p class="text-lg text-primary font-semibold">Manikandan K S</p>
            <p class="text-xs text-gray-500 mt-1">4 trips created</p>
        </div>
        <div class="card-payanam p-6 text-center animate-pulse">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-chart-line text-white text-2xl"></i>
            </div>
            <h3 class="text-2xl font-bold text-accent">Recent Activity</h3>
            <p class="text-lg text-primary font-semibold">12 new activities</p>
            <p class="text-xs text-gray-500 mt-1">added this week</p>
        </div>
    </div>
    <!-- Stats Cards (Dynamic) -->
    <div class="grid md:grid-cols-4 gap-6 mb-8" data-aos="fade-up">
        <div class="card-payanam p-6 text-center">
            <div class="w-16 h-16 gradient-primary rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-users text-white text-2xl"></i>
            </div>
            <h3 class="text-3xl font-bold text-accent">{{ stats.total_users }}</h3>
            <p class="text-gray-500">Total Users</p>
        </div>
        <div class="card-payanam p-6 text-center">
            <div class="w-16 h-16 gradient-accent rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-route text-white text-2xl"></i>
            </div>
            <h3 class="text-3xl font-bold text-accent">{{ stats.total_trips }}</h3>
            <p class="text-gray-500">Total Trips</p>
        </div>
        <div class="card-payanam p-6 text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-city text-white text-2xl"></i>
            </div>
            <h3 class="text-3xl font-bold text-accent">{{ stats.total_cities }}</h3>
            <p class="text-gray-500">Cities</p>
        </div>
        <div class="card-payanam p-6 text-center">
            <div class="w-16 h-16 bg-blue-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-hiking text-white text-2xl"></i>
            </div>
            <h3 class="text-3xl font-bold text-accent">{{ stats.total_activities }}</h3>
            <p class="text-gray-500">Activities</p>
        </div>
    </div>

    <!-- Tabs -->
    <div class="card-payanam overflow-hidden" data-aos="fade-up">
        <div class="flex border-b border-gray-100">
            <button onclick="showTab('users')" class="admin-tab active px-6 py-4 font-medium text-gray-600 hover:text-primary transition-colors" data-tab="users">
                <i class="fas fa-users mr-2"></i>Users
            </button>
            <button onclick="showTab('trips')" class="admin-tab px-6 py-4 font-medium text-gray-600 hover:text-primary transition-colors" data-tab="trips">
                <i class="fas fa-route mr-2"></i>Trips
            </button>
            <button onclick="showTab('cities')" class="admin-tab px-6 py-4 font-medium text-gray-600 hover:text-primary transition-colors" data-tab="cities">
                <i class="fas fa-city mr-2"></i>Cities
            </button>
            <button onclick="showTab('activities')" class="admin-tab px-6 py-4 font-medium text-gray-600 hover:text-primary transition-colors" data-tab="activities">
                <i class="fas fa-hiking mr-2"></i>Activities
            </button>
        </div>

        <!-- Users Tab -->
        <div id="users-tab" class="admin-tab-content p-6">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-accent">Registered Users</h2>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchUsers" class="input-payanam pl-10" placeholder="Search users..." onkeyup="filterTable('usersTable', this.value)">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="usersTable">
                    <thead>
                        <tr class="bg-cream">
                            <th class="text-left p-4 font-medium text-gray-600">ID</th>
                            <th class="text-left p-4 font-medium text-gray-600">Name</th>
                            <th class="text-left p-4 font-medium text-gray-600">Email</th>
                            <th class="text-left p-4 font-medium text-gray-600">Trips</th>
                            <th class="text-left p-4 font-medium text-gray-600">Created</th>
                            <th class="text-left p-4 font-medium text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr class="border-b border-gray-50 hover:bg-cream/50 transition-colors">
                            <td class="p-4 text-gray-600">{{ user.user_id[:8] }}...</td>
                            <td class="p-4 font-medium text-accent">{{ user.name }}</td>
                            <td class="p-4 text-gray-600">{{ user.email }}</td>
                            <td class="p-4">
                                <span class="badge-payanam">{{ user.trips|length }} trips</span>
                            </td>
                            <td class="p-4 text-gray-500 text-sm">{{ user.created_at.strftime('%d %b %Y') if user.created_at else 'N/A' }}</td>
                            <td class="p-4">
                                <button onclick="deleteUser('{{ user.user_id }}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete User">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Trips Tab -->
        <div id="trips-tab" class="admin-tab-content p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-bold text-accent">All Trips</h2>
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchTrips" class="input-payanam pl-10" placeholder="Search trips..." onkeyup="filterTable('tripsTable', this.value)">
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="tripsTable">
                    <thead>
                        <tr class="bg-cream">
                            <th class="text-left p-4 font-medium text-gray-600">Trip Name</th>
                            <th class="text-left p-4 font-medium text-gray-600">User</th>
                            <th class="text-left p-4 font-medium text-gray-600">Category</th>
                            <th class="text-left p-4 font-medium text-gray-600">Dates</th>
                            <th class="text-left p-4 font-medium text-gray-600">Budget</th>
                            <th class="text-left p-4 font-medium text-gray-600">Status</th>
                            <th class="text-left p-4 font-medium text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for trip in trips %}
                        <tr class="border-b border-gray-50 hover:bg-cream/50 transition-colors">
                            <td class="p-4 font-medium text-accent">{{ trip.trip_name }}</td>
                            <td class="p-4 text-gray-600">{{ trip.owner.name if trip.owner else 'Unknown' }}</td>
                            <td class="p-4">
                                <span class="text-xs px-2 py-1 rounded-full bg-primary/10 text-primary capitalize">{{ trip.trip_category }}</span>
                            </td>
                            <td class="p-4 text-gray-500 text-sm">{{ trip.start_date }} - {{ trip.end_date }}</td>
                            <td class="p-4 text-gray-600">₹{{ trip.total_budget }}</td>
                            <td class="p-4">
                                {% if trip.is_public %}
                                <span class="text-xs px-2 py-1 rounded-full bg-green-100 text-green-600">Public</span>
                                {% else %}
                                <span class="text-xs px-2 py-1 rounded-full bg-gray-100 text-gray-600">Private</span>
                                {% endif %}
                            </td>
                            <td class="p-4">
                                <a href="{{ url_for('view_trip', trip_id=trip.trip_id) }}" class="text-primary hover:text-secondary transition-colors mr-3" title="View Trip">
                                    <i class="fas fa-eye"></i>
                                </a>
                                <button onclick="deleteTrip('{{ trip.trip_id }}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete Trip">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Cities Tab -->
        <div id="cities-tab" class="admin-tab-content p-6 hidden">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <h2 class="text-xl font-bold text-accent">Cities Database ({{ cities|length }} cities)</h2>
                <div class="flex gap-3">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchCities" class="input-payanam pl-10" placeholder="Search cities..." onkeyup="filterCities(this.value)">
                    </div>
                    <button onclick="openAddCityModal()" class="btn-payanam">
                        <i class="fas fa-plus mr-2"></i>Add City
                    </button>
                </div>
            </div>
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4" id="citiesGrid">
                {% for city in cities %}
                <div class="card-payanam p-4 flex items-center gap-4 city-card hover:shadow-lg transition-all duration-300" data-name="{{ city.name|lower }}" data-state="{{ city.state|lower }}">
                    <img src="{{ city.image_url or 'https://via.placeholder.com/100?text=City' }}" alt="{{ city.name }}" class="w-16 h-16 rounded-lg object-cover" onerror="this.src='https://via.placeholder.com/100?text=City'">
                    <div class="flex-1 min-w-0">
                        <h3 class="font-medium text-accent truncate">{{ city.name }}</h3>
                        <p class="text-sm text-gray-500">{{ city.state }}</p>
                        <p class="text-xs text-gray-400">{{ city.activities|length }} activities</p>
                    </div>
                    <div class="flex flex-col gap-2">
                        <span class="text-xs px-2 py-1 bg-primary/10 text-primary rounded-full capitalize">{{ city.category }}</span>
                        <button onclick="deleteCity('{{ city.city_id }}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete City">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                {% else %}
                <div class="col-span-full p-8 text-center text-gray-500">
                    <i class="fas fa-city text-4xl mb-4 text-gray-300"></i>
                    <p>No cities found</p>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Activities Tab -->
        <div id="activities-tab" class="admin-tab-content p-6 hidden">
            <div class="flex items-center justify-between mb-6 flex-wrap gap-4">
                <h2 class="text-xl font-bold text-accent">Activities Database ({{ activities|length }} activities)</h2>
                <div class="flex gap-3">
                    <div class="relative">
                        <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400"></i>
                        <input type="text" id="searchActivities" class="input-payanam pl-10" placeholder="Search activities..." onkeyup="filterTable('activitiesTable', this.value)">
                    </div>
                    <button onclick="openAddActivityModal()" class="btn-payanam">
                        <i class="fas fa-plus mr-2"></i>Add Activity
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full" id="activitiesTable">
                    <thead>
                        <tr class="bg-cream">
                            <th class="text-left p-4 font-medium text-gray-600">Activity</th>
                            <th class="text-left p-4 font-medium text-gray-600">City</th>
                            <th class="text-left p-4 font-medium text-gray-600">Category</th>
                            <th class="text-left p-4 font-medium text-gray-600">Duration</th>
                            <th class="text-left p-4 font-medium text-gray-600">Cost</th>
                            <th class="text-left p-4 font-medium text-gray-600">Rating</th>
                            <th class="text-left p-4 font-medium text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for activity in activities %}
                        <tr class="border-b border-gray-50 hover:bg-cream/50 transition-colors">
                            <td class="p-4 font-medium text-accent">{{ activity.name }}</td>
                            <td class="p-4 text-gray-600">{{ activity.city.name if activity.city else 'N/A' }}, {{ activity.city.state if activity.city else '' }}</td>
                            <td class="p-4">
                                <span class="text-xs px-2 py-1 rounded-full bg-primary/10 text-primary capitalize">{{ activity.category }}</span>
                            </td>
                            <td class="p-4 text-gray-500">{{ activity.duration_hours }} hrs</td>
                            <td class="p-4 text-gray-600 font-semibold">₹{{ "{:,.0f}".format(activity.estimated_cost) }}</td>
                            <td class="p-4">
                                <span class="text-yellow-500">{% for i in range(activity.rating|int) %}★{% endfor %}{% for i in range(5 - activity.rating|int) %}☆{% endfor %}</span>
                                <span class="text-xs text-gray-400 ml-1">{{ activity.rating }}</span>
                            </td>
                            <td class="p-4">
                                <button onclick="deleteActivity('{{ activity.activity_id }}')" class="text-red-500 hover:text-red-700 transition-colors" title="Delete Activity">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                        {% else %}
                        <tr>
                            <td colspan="7" class="p-8 text-center text-gray-500">
                                <i class="fas fa-hiking text-4xl mb-4 text-gray-300"></i>
                                <p>No activities found</p>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Add City Modal -->
<div id="addCityModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl max-w-md w-full mx-4 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-accent">Add New City</h3>
            <button onclick="closeModal('addCityModal')" class="text-gray-400 hover:text-gray-600" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form action="{{ url_for('admin_add_city') }}" method="POST">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City Name</label>
                    <input type="text" name="city_name" class="input-payanam w-full" required placeholder="e.g., Jaipur">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
                    <input type="text" name="state" class="input-payanam w-full" required placeholder="e.g., Rajasthan">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Image URL</label>
                    <input type="url" name="image_url" class="input-payanam w-full" placeholder="https://...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" class="input-payanam w-full" rows="3"></textarea>
                </div>
                <button type="submit" class="btn-payanam w-full">
                    <i class="fas fa-plus mr-2"></i>Add City
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Add Activity Modal -->
<div id="addActivityModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-3xl max-w-md w-full mx-4 p-6">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-xl font-bold text-accent">Add New Activity</h3>
            <button onclick="closeModal('addActivityModal')" class="text-gray-400 hover:text-gray-600" title="Close">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form action="{{ url_for('admin_add_activity') }}" method="POST">
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Activity Name</label>
                    <input type="text" name="activity_name" class="input-payanam w-full" required placeholder="e.g., Amber Fort Tour">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
                    <select name="city_id" class="input-payanam w-full" required title="Select a city">
                        <option value="">Select a city...</option>
                        {% for city in cities %}
                        <option value="{{ city.city_id }}">{{ city.name }}, {{ city.state }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Type</label>
                        <select name="activity_type" class="input-payanam w-full" title="Select activity type">
                            <option value="sightseeing">Sightseeing</option>
                            <option value="temple">Temple</option>
                            <option value="adventure">Adventure</option>
                            <option value="nature">Nature</option>
                            <option value="food">Food</option>
                            <option value="shopping">Shopping</option>
                            <option value="beach">Beach</option>
                            <option value="heritage">Heritage</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Duration</label>
                        <input type="text" name="duration" class="input-payanam w-full" placeholder="2 hours">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Cost (₹)</label>
                    <input type="number" name="cost" class="input-payanam w-full" value="0" min="0" placeholder="500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>
                    <textarea name="description" class="input-payanam w-full" rows="3" placeholder="Brief description of the activity..."></textarea>
                </div>
                <button type="submit" class="btn-payanam w-full">
                    <i class="fas fa-plus mr-2"></i>Add Activity
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .admin-tab.active {
        color: var(--primary);
        border-bottom: 3px solid var(--primary);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Tab switching
    function showTab(tabName) {
        document.querySelectorAll('.admin-tab-content').forEach(tab => tab.classList.add('hidden'));
        document.querySelectorAll('.admin-tab').forEach(btn => btn.classList.remove('active'));
        
        document.getElementById(tabName + '-tab').classList.remove('hidden');
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    }
    
    // Table filtering
    function filterTable(tableId, query) {
        const table = document.getElementById(tableId);
        const rows = table.querySelectorAll('tbody tr');
        query = query.toLowerCase();
        
        rows.forEach(row => {
            const text = row.textContent.toLowerCase();
            row.style.display = text.includes(query) ? '' : 'none';
        });
    }
    
    // Cities filtering
    function filterCities(query) {
        const cards = document.querySelectorAll('.city-card');
        query = query.toLowerCase();
        
        cards.forEach(card => {
            const name = card.dataset.name || '';
            const state = card.dataset.state || '';
            const matches = name.includes(query) || state.includes(query);
            card.style.display = matches ? '' : 'none';
        });
    }
    
    function openAddCityModal() {
        document.getElementById('addCityModal').classList.remove('hidden');
    }
    
    function openAddActivityModal() {
        document.getElementById('addActivityModal').classList.remove('hidden');
    }
    
    function closeModal(modalId) {
        document.getElementById(modalId).classList.add('hidden');
    }
    
    async function deleteUser(userId) {
        if (!confirm('Are you sure you want to delete this user? This will also delete all their trips.')) return;
        
        try {
            const response = await fetch(`/admin/api/user/${userId}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete user');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteTrip(tripId) {
        if (!confirm('Are you sure you want to delete this trip?')) return;
        
        try {
            const response = await fetch(`/admin/api/trip/${tripId}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete trip');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteCity(cityId) {
        if (!confirm('Are you sure you want to delete this city? This will also delete all activities in this city.')) return;
        
        try {
            const response = await fetch(`/admin/api/city/${cityId}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete city');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    async function deleteActivity(activityId) {
        if (!confirm('Are you sure you want to delete this activity?')) return;
        
        try {
            const response = await fetch(`/admin/api/activity/${activityId}`, { method: 'DELETE' });
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete activity');
            }
        } catch (error) {
            alert('Error: ' + error.message);
        }
    }
    
    // Close modals on outside click
    document.querySelectorAll('[id$="Modal"]').forEach(modal => {
        modal.addEventListener('click', (e) => {
            if (e.target === modal) closeModal(modal.id);
        });
    });
</script>
{% endblock %}
